# Design 2 - 开发者模式功能

## Requirements

### 功能概述
为Vocab App添加开发者模式功能，让开发者能够深入调试和管理应用。开发者模式主要包含两个核心功能：

1. **终端信息查看功能**
   - 能够查看应用运行时的控制台输出和日志信息
   - 包括Electron主进程、渲染进程和数据库操作的日志
   - 提供实时日志流和历史日志查看
   - 支持日志级别过滤（info、warning、error、debug）
   - 支持日志搜索和导出功能

2. **SQL数据库调用功能**
   - 提供SQL查询编辑器，允许直接对SQLite数据库执行查询
   - 支持SELECT、INSERT、UPDATE、DELETE等基本SQL操作
   - 提供查询结果的表格化显示
   - 包含查询历史记录功能
   - 具备SQL语法高亮和基本的自动补全功能
   - 提供数据库schema浏览器，查看表结构和索引信息

### 安全要求
- 开发者模式需要通过设置界面明确启用
- 在生产环境中默认禁用，避免普通用户误用
- SQL操作需要有确认机制，特别是DELETE和UPDATE操作
- 提供数据备份提醒功能

### 用户体验要求
- 开发者模式作为主窗口内的独立页面（类似设置页面）
- 通过Cmd+4快捷键快速访问开发者模式
- 在设置界面中提供开发者模式的开关控制
- 界面风格应与应用整体设计保持一致，使用相同的glass-panel样式
- DELETE/UPDATE等危险SQL操作需要二次确认对话框

### 技术集成要求
- 利用现有的IPC通信机制
- 扩展当前的VocabDatabase类以支持任意SQL查询
- 在设置存储中保存开发者模式状态
- 日志系统应能够收集来自主进程和渲染进程的信息
- 特别收集Tesseract OCR操作和Claude API调用的详细日志
- 与现有的electron-store配置系统集成
- 集成到现有的路由系统中（window.location.hash）

### 性能要求
- 日志收集不应明显影响应用性能
- SQL查询结果集过大时应提供分页功能
- 开发者模式开关应立即生效，无需重启应用

### 兼容性要求
- 与现有的词汇管理功能完全兼容
- 不影响现有的快捷键系统（Cmd+1、Cmd+2、Cmd+3）
- 支持当前的主题系统（浅色/深色/跟随系统）

## Solution

### 1. 日志系统设计

**日志收集架构:**
```typescript
// src/main/logger.ts - 新增日志服务
class LoggerService {
  private logs: LogEntry[] = [];
  private maxLogs = 1000; // 最大日志条数
  
  log(level: 'info' | 'warning' | 'error' | 'debug', source: string, message: string, data?: any)
  getLogs(level?: string, source?: string): LogEntry[]
  clearLogs(): void
  exportLogs(): string
}

// 集成点:
// - main.ts: OCR操作、窗口管理日志
// - claude-service.ts: API调用成功/失败日志
// - database.ts: SQL执行日志
// - 渲染进程: 通过IPC发送前端日志
```

**日志数据结构:**
```typescript
interface LogEntry {
  id: string;
  timestamp: string;
  level: 'info' | 'warning' | 'error' | 'debug';
  source: 'main' | 'renderer' | 'database' | 'claude-api' | 'ocr';
  message: string;
  data?: any;
}
```

### 2. SQL查询系统设计

**数据库扩展:**
```typescript
// 扩展database.ts
class VocabDatabase {
  // 新增开发者专用方法
  executeSQL(query: string): { columns: string[], rows: any[], error?: string }
  getSchema(): TableInfo[]
  validateQuery(query: string): { isValid: boolean, isDangerous: boolean, message?: string }
}

interface TableInfo {
  name: string;
  columns: ColumnInfo[];
  indexes: string[];
}
```

**安全机制:**
- SQL查询前预解析，识别危险操作（DELETE、UPDATE、DROP等）
- 危险操作弹出确认对话框，显示影响行数预估
- 只读查询直接执行，写操作需要开发者模式开关启用

### 3. UI组件设计

**路由扩展:**
```typescript
// App.tsx路由系统扩展
const routes = {
  '': <MainWindow />,
  'settings': <Settings />,
  'developer': <DeveloperMode />, // 新增
  'quick-input': <QuickInput />,
  'ocr-result': <OCRResult />
}
```

**开发者界面组件:**
```typescript
// components/DeveloperMode.tsx
interface DeveloperModeProps {}

// 包含两个主要Tab:
// 1. LogViewer: 日志查看器
// 2. SQLConsole: SQL控制台
```

**设置界面集成:**
```typescript
// Settings.tsx 新增开发者模式开关
const [developerMode, setDeveloperMode] = useState(false);

// 新增开发者模式配置区块，包含:
// - 开发者模式开关
// - 快捷键提示 (Cmd+4)
```

### 4. IPC接口设计

**主进程新增接口:**
```typescript
// main.ts IPC handlers
ipcMain.handle('dev-get-logs', (_, filter) => logger.getLogs(filter))
ipcMain.handle('dev-execute-sql', (_, query) => database.executeSQL(query))
ipcMain.handle('dev-get-schema', () => database.getSchema())
ipcMain.handle('dev-clear-logs', () => logger.clearLogs())
ipcMain.handle('dev-export-logs', () => logger.exportLogs())

// 设置相关
ipcMain.handle('get-developer-mode', () => store.get('developerMode', false))
ipcMain.handle('set-developer-mode', (_, enabled) => store.set('developerMode', enabled))
```

**preload.ts扩展:**
```typescript
const api = {
  // ...现有API
  developer: {
    getLogs: (filter?: any) => ipcRenderer.invoke('dev-get-logs', filter),
    executeSQL: (query: string) => ipcRenderer.invoke('dev-execute-sql', query),
    getSchema: () => ipcRenderer.invoke('dev-get-schema'),
    clearLogs: () => ipcRenderer.invoke('dev-clear-logs'),
    exportLogs: () => ipcRenderer.invoke('dev-export-logs'),
    isEnabled: () => ipcRenderer.invoke('get-developer-mode'),
    setEnabled: (enabled: boolean) => ipcRenderer.invoke('set-developer-mode', enabled),
  }
}
```

### 5. 实现优先级

**Phase 1: 基础架构**
1. LoggerService类和日志收集系统
2. VocabDatabase扩展SQL执行方法
3. IPC接口定义和实现

**Phase 2: UI组件**
1. DeveloperMode主组件
2. LogViewer日志查看器子组件
3. SQLConsole SQL控制台子组件

**Phase 3: 集成和安全**
1. 快捷键Cmd+4注册
2. 设置界面开发者模式开关
3. 危险操作确认对话框
4. 路由系统集成

## Tests

### 日志系统测试
1. **日志收集测试**
   - 验证各组件日志正确收集到LoggerService
   - 测试日志级别过滤功能
   - 验证最大日志条数限制（1000条）
   - 测试日志导出为文本格式

2. **实时日志测试**
   - 执行OCR操作，验证相关日志实时显示
   - 调用Claude API，验证请求/响应日志
   - 执行词汇添加/删除，验证数据库操作日志

### SQL系统测试
1. **查询执行测试**
   - 测试基本SELECT查询正常执行
   - 验证查询结果表格正确显示
   - 测试复杂JOIN查询的性能和结果

2. **安全机制测试**
   - 执行DELETE查询，验证二次确认对话框出现
   - 测试危险操作的预解析和提示
   - 验证开发者模式关闭时写操作被拒绝
   - 测试SQL注入防护机制

3. **Schema浏览器测试**
   - 验证数据库表结构正确显示
   - 测试索引信息的准确性
   - 验证列类型和约束显示正确

### 界面集成测试
1. **快捷键测试**
   - Cmd+4快捷键正确打开开发者模式
   - 验证不影响现有快捷键（Cmd+1/2/3）

2. **路由测试**
   - 通过URL hash导航到开发者模式
   - 测试页面间切换的流畅性
   - 验证浏览器前进/后退按钮功能

3. **设置集成测试**
   - 开发者模式开关正确保存和加载
   - 测试设置界面的开发者配置区块
   - 验证模式切换立即生效

### 性能测试
1. **日志性能测试**
   - 高频日志生成不影响应用响应性
   - 大量日志查看的渲染性能
   - 日志搜索功能的响应速度

2. **SQL查询性能测试**
   - 大结果集查询的内存使用
   - 复杂查询的执行时间限制
   - 查询结果分页功能测试

### 用户体验测试
1. **主题适配测试**
   - 开发者界面在浅色/深色主题下的显示效果
   - glass-panel样式与整体设计的一致性

2. **错误处理测试**
   - SQL语法错误的友好提示
   - 网络异常时日志系统的稳定性
   - 异常情况下的优雅降级

### 手动测试场景
1. **开发者工作流测试**
   - 开启开发者模式 → 执行OCR → 查看OCR日志
   - 运行词汇翻译 → 查看Claude API调用日志
   - 执行数据库查询 → 验证结果显示
   - 尝试删除操作 → 确认安全提示

2. **多窗口交互测试**
   - 同时打开设置和开发者模式
   - 在快速输入窗口操作时查看主窗口日志
   - 验证日志实时更新功能